# ๐ ุณุณุชู ุฐุฎุฑูโุณุงุฒ ฺฉุงูู ูพุงูโูุง ู ูุงูโูุง

## โ ุชุบุฑุงุช ุงุนูุงู ุดุฏู

### 1๏ธโฃ **Soft Delete ุจุฑุง ูพุงูโูุง**
ุชูุงู ูพุงูโูุง ุฏุฑ ุฏุชุงุจุณ ุจุงู ูโูุงููุฏ ู ููุท ุงุฒ ุชูฺฏุฑุงู ูพุงฺฉ ูโุดููุฏ.

#### ุฌุฏุงูู ุจูโุฑูุฒุฑุณุงู ุดุฏู:
- โ `random_chat_messages` - ูพุงูโูุง ฺุช ุชุตุงุฏู
- โ `messages` - ูพุงูโูุง ฺุช ุนุงุฏ  
- โ `directs` - ูพุงูโูุง ูุณุชูู
- โ `direct_messages` - ูพุงูโูุง ุฏุงุฑฺฉุช
- โ `anonymous_messages` - ูพุงูโูุง ูุงุดูุงุณ

#### ููุฏูุง ุงุถุงูู ุดุฏู:
```sql
-- ุจุฑุง ูุฑ ฺฉุงุฑุจุฑ ุฌุฏุงฺฏุงูู
is_deleted_user1 BOOLEAN DEFAULT FALSE
is_deleted_user2 BOOLEAN DEFAULT FALSE
deleted_at_user1 TIMESTAMP
deleted_at_user2 TIMESTAMP
deleted_by_user1 INTEGER
deleted_by_user2 INTEGER
```

### 2๏ธโฃ **ุฐุฎุฑูโุณุงุฒ ูุงูโูุง ุฑู ุณุฑูุฑ**
ุชูุงู ูุงูโูุง (ุนฺฉุณุ ูุฏูุ ุตูุชุ ุณูุฏ) ุฑู ุณุฑูุฑ ุฐุฎุฑู ูโุดููุฏ.

#### ููุฏูุง ุงุถุงูู ุดุฏู:
```sql
local_file_path TEXT          -- ูุณุฑ ูุงู ุฑู ุณุฑูุฑ
file_size INTEGER              -- ุญุฌู ูุงู (ุจุงุช)
mime_type VARCHAR(100)         -- ููุน ูุงู
```

#### ุณุงุฎุชุงุฑ ูพูุดูโูุง:
```
public/uploads/
โโโ images/      (ุชุตุงูุฑ)
โโโ videos/      (ูุฏููุง)
โโโ voices/      (ุตุฏุงูุง)
โโโ documents/   (ุงุณูุงุฏ)
โโโ stickers/    (ุงุณุชฺฉุฑูุง)
```

### 3๏ธโฃ **ูุญุฏูุฏุช ุญุฌู ูุงู**
- ุญุฏุงฺฉุซุฑ ุญุฌู: **50 ูฺฏุงุจุงุช**
- ุจุฑุฑุณ ูุจู ุงุฒ ุฏุงูููุฏ
- ูุณุฏูุฏ ฺฉุฑุฏู ูุงูโูุง ุจุฒุฑฺฏโุชุฑ

### 4๏ธโฃ **ุญูุธ ุฏุงุฏูโูุง ุจุง ุชุบุฑ CASCADE**
ุฌุฏุงูู ุงุตู ุฏฺฏุฑ ุจุง `ON DELETE CASCADE` ูุณุชูุฏ:
- `random_chats`: CASCADE โ **RESTRICT**
- `chats`: CASCADE โ **RESTRICT**
- ุญุฐู ฺฉุงุฑุจุฑ ุจุงุนุซ ุญุฐู ูพุงูโูุง ููโุดูุฏ

---

## ๐ง ูุงูโูุง ุฌุฏุฏ

### 1. `src/utils/storage.ts`
ุณุฑูุณ ุฐุฎุฑูโุณุงุฒ ูุงูโูุง:
- `downloadAndSaveFile()` - ุฏุงูููุฏ ู ุฐุฎุฑู ูุงู ุงุฒ ุชูฺฏุฑุงู
- `deleteFile()` - ุญุฐู ูุงู ุงุฒ ุณุฑูุฑ
- `checkFileSize()` - ุจุฑุฑุณ ุญุฌู ูุงู
- `formatFileSize()` - ูุฑูุช ฺฉุฑุฏู ุญุฌู ุจุฑุง ููุงุด

---

## ๐ ูุงูโูุง ุจูโุฑูุฒุฑุณุงู ุดุฏู

### 1. `src/database/schema.sql`
- ุงุถุงูู ฺฉุฑุฏู ููุฏูุง soft delete ุจู ุชูุงู ุฌุฏุงูู ูพุงู
- ุงุถุงูู ฺฉุฑุฏู ููุฏูุง ุฐุฎุฑู ูุงู (local_file_path, file_size, mime_type)
- ุชุบุฑ ON DELETE CASCADE ุจู RESTRICT
- ุงุถุงูู ฺฉุฑุฏู ุงูุฏฺฉุณโูุง ูุฑุจูุทู

### 2. `src/services/randomChat.service.ts`
ูุชุฏูุง ุฌุฏุฏ:
```typescript
// Soft delete ูพุงูโูุง
softDeleteMessages(chatId, userId)

// ุฏุฑุงูุช ูพุงูโูุง ูุนุงู
getActiveMessagesForUser(chatId, userId)

// ุฏุฑุงูุช ุชูุงู ูพุงูโูุง (ุจุฑุง ุงุฏูู)
getAllMessagesIncludingDeleted(chatId)
```

### 3. `src/bot/handlers/randomChat.handler.ts`
- ุฐุฎุฑู ูุงูโูุง ููฺฏุงู ุงุฑุณุงู ูพุงู
- ุงุณุชูุงุฏู ุงุฒ soft delete ุฏุฑ `deleteChatMessages()`
- ููุงุด ุชุนุฏุงุฏ ูพุงูโูุง ูพุงฺฉ ุดุฏู

### 4. `src/bot/index.ts`
- Initialize ฺฉุฑุฏู storage ููฺฏุงู ุฑุงูโุงูุฏุงุฒ

---

## ๐ ูุญูู ุงุณุชูุงุฏู

### ุฑุงูโุงูุฏุงุฒ ุฏุชุงุจุณ:
```bash
# ุงุฌุฑุง schema.sql ฺฉุงูู
psql -U your_user -d your_database -f src/database/schema.sql

# ุง ุจุง ุงุณฺฉุฑูพุช helper:
./scripts/run-migration.sh
```

---

## ๐ ูุญูู ฺฉุงุฑ

### 1๏ธโฃ **ุงุฑุณุงู ูพุงู ุจุง ูุงู:**
```
ฺฉุงุฑุจุฑ ูพุงู ูโูุฑุณุชุฏ
    โ
ูุงู ุงุฒ ุชูฺฏุฑุงู ุฏุงูููุฏ ูโุดูุฏ
    โ
ุฑู ุณุฑูุฑ ุฐุฎุฑู ูโุดูุฏ (/uploads)
    โ
ุงุทูุงุนุงุช ุฏุฑ ุฏุชุงุจุณ ุฐุฎุฑู ูโุดูุฏ
    (file_id + local_file_path + file_size)
```

### 2๏ธโฃ **ูพุงฺฉ ฺฉุฑุฏู ูพุงู:**
```
ฺฉุงุฑุจุฑ /delete_CHAT_ID ุฑุง ูโุฒูุฏ
    โ
ูพุงูโูุง ุงุฒ ุชูฺฏุฑุงู ูพุงฺฉ ูโุดููุฏ
    โ
ุฏุฑ ุฏุชุงุจุณ ููฺฏ is_deleted_userX = true
    โ
ูพุงูโูุง ููฺูุงู ูุงุจู ุจุงุฒุงุจ ูุณุชูุฏ
```

### 3๏ธโฃ **ุจุงุฒุงุจ ูพุงูโูุง (ุงุฏูู):**
```sql
-- ุฏุฑุงูุช ุชูุงู ูพุงูโูุง ฺฉ ฺุช (ุญุช ูพุงฺฉ ุดุฏูโูุง)
SELECT * FROM random_chat_messages 
WHERE chat_id = 123 
ORDER BY created_at;

-- ููุชุฑ ูพุงูโูุง ูพุงฺฉ ุดุฏู
SELECT * FROM random_chat_messages 
WHERE chat_id = 123 
  AND (is_deleted_user1 = true OR is_deleted_user2 = true);
```

---

## ๐ Query ูุง ููุฏ

### ุชูุงู ูพุงูโูุง ูพุงฺฉ ุดุฏู:
```sql
SELECT 
  m.id,
  m.message_text,
  m.message_type,
  m.local_file_path,
  m.file_size,
  u1.first_name as user1_name,
  u2.first_name as user2_name,
  m.is_deleted_user1,
  m.is_deleted_user2,
  m.deleted_at_user1,
  m.deleted_at_user2
FROM random_chat_messages m
JOIN random_chats rc ON m.chat_id = rc.id
JOIN users u1 ON rc.user1_id = u1.id
JOIN users u2 ON rc.user2_id = u2.id
WHERE m.is_deleted_user1 = true OR m.is_deleted_user2 = true
ORDER BY m.deleted_at_user1 DESC, m.deleted_at_user2 DESC;
```

### ูุงูโูุง ุฐุฎุฑู ุดุฏู:
```sql
SELECT 
  message_type,
  COUNT(*) as count,
  SUM(file_size) as total_size,
  AVG(file_size) as avg_size
FROM random_chat_messages
WHERE local_file_path IS NOT NULL
GROUP BY message_type;
```

### ุญุฌู ฺฉู ูุงูโูุง:
```sql
SELECT 
  COUNT(*) as total_files,
  pg_size_pretty(SUM(file_size)::bigint) as total_size
FROM random_chat_messages
WHERE local_file_path IS NOT NULL;
```

---

## โ๏ธ ุชูุธูุงุช

### ุชุบุฑ ุญุฏุงฺฉุซุฑ ุญุฌู ูุงู:
ุฏุฑ `src/utils/storage.ts`:
```typescript
const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
```

### ุชุบุฑ ูุณุฑ ุฐุฎุฑู:
```typescript
const UPLOAD_DIR = path.join(__dirname, '../../public/uploads');
```

---

## ๐ก๏ธ ุงููุช

### โ ุญูุงุธุชโูุง ุงุนูุงู ุดุฏู:
1. **ูุญุฏูุฏุช ุญุฌู** - ุฌููฺฏุฑ ุงุฒ ุขูพููุฏ ูุงูโูุง ุจุฒุฑฺฏ
2. **Soft Delete** - ุงูฺฉุงู ุจุงุฒุงุจ ูพุงูโูุง ุญุฐู ุดุฏู
3. **ON DELETE RESTRICT** - ุฌููฺฏุฑ ุงุฒ ุญุฐู ุชุตุงุฏู ุฏุงุฏูโูุง
4. **ุฐุฎุฑู ูุญู** - ุนุฏู ูุงุจุณุชฺฏ ุจู ุณุฑูุฑูุง ุชูฺฏุฑุงู
5. **Unique filenames** - ุฌููฺฏุฑ ุงุฒ ุชุฏุงุฎู ูุงูโูุง

---

## ๐ ูฺฉุงุช ููู

### โ ูุฒุงุง:
- โ ุชูุงู ูพุงูโูุง ู ูุงูโูุง ุฐุฎุฑู ูโุดููุฏ
- โ ูพุงูโูุง ูพุงฺฉ ุดุฏู ูุงุจู ุจุงุฒุงุจ ูุณุชูุฏ
- โ ูุงูโูุง ุฑู ุณุฑูุฑ ูุญู ูฺฏูุฏุงุฑ ูโุดููุฏ
- โ ูุญุฏูุฏุช 50MB ุจุฑุง ูุงูโูุง
- โ ุญูุธ ุงุทูุงุนุงุช ุญุช ุฏุฑ ุญุงูุช Safe Mode

### โ๏ธ ุชูุฌู:
- ูพุงูโูุง ูพุงฺฉ ุดุฏู ููุท ุงุฒ ุชูฺฏุฑุงู ุญุฐู ูโุดููุฏ
- ุฏุฑ ุฏุชุงุจุณ ุจุง ููฺฏ `is_deleted` ุจุงู ูโูุงููุฏ
- ุงุฏูู ูโุชูุงูุฏ ุชูุงู ูพุงูโูุง ุฑุง ุจุจูุฏ
- ูุงูโูุง ูุถุง ุฏุณฺฉ ุงุดุบุงู ูโฺฉููุฏ

---

## ๐ฎ ุงูฺฉุงูุงุช ุขูุฏู

- [ ] Compression ูุงูโูุง ุจุฑุง ฺฉุงูุด ุญุฌู
- [ ] ูพุงฺฉุณุงุฒ ุฎูุฏฺฉุงุฑ ูุงูโูุง ูุฏู
- [ ] ุขูพููุฏ ุจู S3/Cloud Storage
- [ ] ุฑูุฒูฺฏุงุฑ ูุงูโูุง
- [ ] Thumbnail ุจุฑุง ุชุตุงูุฑ ู ูุฏููุง

---

## โ ุชุณุช

ุจุฑุง ุชุณุช ุนููฺฉุฑุฏ:
1. ูพุงู ูุชู + ุนฺฉุณ ุงุฑุณุงู ฺฉูุฏ
2. ุจุฑุฑุณ ฺฉูุฏ ูุงู ุฏุฑ `public/uploads/images` ุฐุฎุฑู ุดุฏู
3. ุฏุณุชูุฑ `/delete_CHAT_ID` ุฑุง ุจุฒูุฏ
4. ุจุฑุฑุณ ฺฉูุฏ ูพุงู ุงุฒ ุชูฺฏุฑุงู ูพุงฺฉ ุดุฏู ูู ุฏุฑ ุฏุชุงุจุณ ูุณุช

---

**ุชุงุฑุฎ:** 2026-01-03  
**ูุณุฎู:** 1.0.0  
**ุชูุณุนู ุฏููุฏู:** CharonX Team
