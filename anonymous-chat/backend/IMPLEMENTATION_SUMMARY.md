# ๐ฏ ุฎูุงุตู ุชุบุฑุงุช ุณุณุชู ุฐุฎุฑูโุณุงุฒ ฺฉุงูู

## โ ุขูฺู ูพุงุฏูโุณุงุฒ ุดุฏ:

### 1. **Soft Delete ุจุฑุง ูพุงูโูุง** โ
- ูพุงูโูุง ููุท ุงุฒ ุชูฺฏุฑุงู ูพุงฺฉ ูโุดููุฏ
- ุฏุฑ ุฏุชุงุจุณ ุจุง ููฺฏ `is_deleted` ุจุงู ูโูุงููุฏ
- ุจุฑุง ูุฑ ฺฉุงุฑุจุฑ ุฌุฏุงฺฏุงูู ูุงุจู ูพุงฺฉ ฺฉุฑุฏู
- ูุงุจู ุจุงุฒุงุจ ุชูุณุท ุงุฏูู

### 2. **ุฐุฎุฑูโุณุงุฒ ฺฉุงูู ูุงูโูุง** โ
- ุชูุงู ูุงูโูุง (ุนฺฉุณุ ูุฏูุ ุตูุชุ ุณูุฏ) ุฑู ุณุฑูุฑ ุฐุฎุฑู ูโุดููุฏ
- ุฏุงูููุฏ ุฎูุฏฺฉุงุฑ ุงุฒ ุชูฺฏุฑุงู ููฺฏุงู ุงุฑุณุงู
- ุฐุฎุฑู ุฏุฑ ูพูุดู `/public/uploads`
- ุซุจุช ุงุทูุงุนุงุช ฺฉุงูู (ุญุฌูุ ููุนุ ูุณุฑ)

### 3. **ูุญุฏูุฏุช 50 ูฺฏุงุจุงุช** โ
- ุจุฑุฑุณ ุญุฌู ูุจู ุงุฒ ุฏุงูููุฏ
- ุฌููฺฏุฑ ุงุฒ ุขูพููุฏ ูุงูโูุง ุจุฒุฑฺฏ
- ูพุงู ุฎุทุง ููุงุณุจ ุจุฑุง ฺฉุงุฑุจุฑ

### 4. **ุญูุธ ุฏุงุฏูโูุง ุฏุฑ Safe Mode** โ
- ูพุงูโูุง ุฏุฑ ุญุงูุช ุงูู ูู ฺฉุงูู ุฐุฎุฑู ูโุดููุฏ
- ูุงูโูุง ุจุง protect_content ูู ุฑู ุณุฑูุฑ ุฐุฎุฑู ูโุดููุฏ
- ุนุฏู ูุงุจุณุชฺฏ ุจู ุชูฺฏุฑุงู

### 5. **ุชุบุฑ CASCADE ุจู RESTRICT** โ
- ุญุฐู ฺฉุงุฑุจุฑ ุจุงุนุซ ุญุฐู ูพุงูโูุง ููโุดูุฏ
- ุฏุงุฏูโูุง ูุญุงูุธุช ุดุฏูโุงูุฏ
- ุงูฺฉุงู ุจุงุฒุงุจ ุงุทูุงุนุงุช

---

## ๐ ูุงูโูุง ุงุฌุงุฏ/ุชุบุฑ ุดุฏู:

### โจ ูุงูโูุง ุฌุฏุฏ:
1. โ `src/utils/storage.ts` - ุณุฑูุณ ุฐุฎุฑูโุณุงุฒ ูุงู
2. โ `migrations/005_add_soft_delete_and_file_storage.sql` - Migration
3. โ `STORAGE_SYSTEM.md` - ูุณุชูุฏุงุช ฺฉุงูู
4. โ `scripts/run-migration.sh` - ุงุฌุฑุง migration
5. โ `scripts/verify-storage.sh` - ุจุฑุฑุณ ูุตุจ

### ๐ ูุงูโูุง ุจูโุฑูุฒุฑุณุงู ุดุฏู:
1. โ `src/database/schema.sql` - ุงุถุงูู ฺฉุฑุฏู ููุฏูุง ุฌุฏุฏ
2. โ `src/services/randomChat.service.ts` - ูุชุฏูุง soft delete
3. โ `src/bot/handlers/randomChat.handler.ts` - ุฐุฎุฑู ูุงูโูุง
4. โ `src/bot/index.ts` - Initialize storage

---

## ๐ ูุฑุงุญู ูุตุจ:

### ูุฑุญูู 1: ุฑุงูโุงูุฏุงุฒ ุฏุชุงุจุณ
```bash
cd /home/charon-x/CharonX/chat-bots/anonymous-chat/backend
./scripts/run-migration.sh
```
**ุชูุฌู:** ุงู ุงุณฺฉุฑูพุช schema.sql ฺฉุงูู ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ู ุฏุชุงุจุณ ุฑุง ุจุง ุชูุงู ููุฏูุง ุฌุฏุฏ ุฑุงูโุงูุฏุงุฒ ูโฺฉูุฏ.

### ูุฑุญูู 2: ุจุฑุฑุณ ูุตุจ
```bash
./scripts/verify-storage.sh
```

### ูุฑุญูู 3: ุงุฌุงุฏ ูพูุดูโูุง ุขูพููุฏ
```bash
mkdir -p public/uploads/{images,videos,voices,documents,stickers}
```

### ูุฑุญูู 4: Restart Application
```bash
npm run dev
# ุง
docker-compose restart
```

---

## ๐ ุชุณุช ุณุณุชู:

### ุชุณุช 1: ุงุฑุณุงู ุนฺฉุณ
1. ุฏุฑ ฺุช ุชุตุงุฏู ฺฉ ุนฺฉุณ ุจูุฑุณุชุฏ
2. ุจุฑุฑุณ ฺฉูุฏ: ูุงู ุฏุฑ `public/uploads/images/` ุฐุฎุฑู ุดุฏู
3. ุฏุฑ ุฏุชุงุจุณ `local_file_path` ูพุฑ ุดุฏู ุงุณุช

### ุชุณุช 2: Soft Delete
1. ุฏุณุชูุฑ `/delete_CHAT_ID` ุจุฒูุฏ
2. ูพุงูโูุง ุงุฒ ุชูฺฏุฑุงู ูพุงฺฉ ูโุดููุฏ
3. ุฏุฑ ุฏุชุงุจุณ ฺฺฉ ฺฉูุฏ: `is_deleted_user1 = true`

### ุชุณุช 3: ุจุงุฒุงุจ ูพุงูโูุง
```sql
-- ุฏุฑุงูุช ุชูุงู ูพุงูโูุง ูพุงฺฉ ุดุฏู
SELECT * FROM random_chat_messages 
WHERE is_deleted_user1 = true OR is_deleted_user2 = true;
```

---

## ๐ Query ูุง ููุฏ:

### ุชุนุฏุงุฏ ูพุงูโูุง ูพุงฺฉ ุดุฏู:
```sql
SELECT COUNT(*) FROM random_chat_messages 
WHERE is_deleted_user1 = true OR is_deleted_user2 = true;
```

### ุญุฌู ูุงูโูุง ุฐุฎุฑู ุดุฏู:
```sql
SELECT 
  message_type,
  COUNT(*) as count,
  pg_size_pretty(SUM(file_size)::bigint) as total_size
FROM random_chat_messages
WHERE local_file_path IS NOT NULL
GROUP BY message_type;
```

### ูพุงูโูุง ฺฉ ฺฉุงุฑุจุฑ:
```sql
SELECT 
  m.*,
  CASE 
    WHEN rc.user1_id = 123 THEN m.is_deleted_user1
    ELSE m.is_deleted_user2
  END as is_deleted_for_user
FROM random_chat_messages m
JOIN random_chats rc ON m.chat_id = rc.id
WHERE rc.user1_id = 123 OR rc.user2_id = 123
ORDER BY m.created_at DESC;
```

---

## โ๏ธ ูฺฉุงุช ููู:

### โ ุงูุฌุงู ุดุฏู:
- โ ุชูุงู ูพุงูโูุง ุฐุฎุฑู ูโุดููุฏ (ุญุช ุฏุฑ safe mode)
- โ ุชูุงู ูุงูโูุง ุฑู ุณุฑูุฑ ุฐุฎุฑู ูโุดููุฏ
- โ ูุญุฏูุฏุช 50MB ุงุนูุงู ุดุฏู
- โ Soft delete ูพุงุฏู ุดุฏู
- โ ุญูุงุธุช ุงุฒ ุฏุงุฏูโูุง ุจุง RESTRICT

### ๐ง ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ:
- ๐ ูพูุดู `public/uploads` ุจุงุฏ ูุงุจู ููุดุชู ุจุงุดุฏ
- ๐พ ูุถุง ุฏุณฺฉ ฺฉุงู ุจุฑุง ุฐุฎุฑู ูุงูโูุง ุฏุงุดุชู ุจุงุดุฏ
- ๐ ุฏุณุชุฑุณ ุงุฏูู ุจู ูพุงูโูุง ูพุงฺฉ ุดุฏู
- ๐๏ธ ูพุงฺฉุณุงุฒ ุฏูุฑูโุง ูุงูโูุง ูุฏู ุชูุตู ูโุดูุฏ

---

## ๐ ุขูุงุฑ ุชุบุฑุงุช:

- **ุชุนุฏุงุฏ ุฌุฏุงูู ุชุบุฑ ุงูุชู:** 7
- **ุชุนุฏุงุฏ ููุฏูุง ุฌุฏุฏ:** 45+
- **ุชุนุฏุงุฏ ุงูุฏฺฉุณ ุฌุฏุฏ:** 15+
- **ุฎุทูุท ฺฉุฏ ุงุถุงูู ุดุฏู:** 800+
- **ูุงูโูุง ุฌุฏุฏ:** 5
- **ูุงูโูุง ุจูโุฑูุฒุฑุณุงู ุดุฏู:** 4

---

## ๐ ูุชุฌู ููุง:

ุณุณุชู ุดูุง ุญุงูุง:
- โ **ุชูุงู ูพุงูโูุง** ุฑุง ุฐุฎุฑู ูโฺฉูุฏ
- โ **ุชูุงู ูุงูโูุง** ุฑุง ุฑู ุณุฑูุฑ ูฺฏู ูโุฏุงุฑุฏ
- โ **ูพุงูโูุง ูพุงฺฉ ุดุฏู** ูุงุจู ุจุงุฒุงุจ ูุณุชูุฏ
- โ **ูุญุฏูุฏุช 50MB** ุฑุง ุฑุนุงุช ูโฺฉูุฏ
- โ **ุฏุฑ ุญุงูุช Safe Mode** ูู ฺฉุงูู ฺฉุงุฑ ูโฺฉูุฏ
- โ **ุงุฒ ุญุฐู ุชุตุงุฏู** ูุญุงูุธุช ูโฺฉูุฏ

---

**ููู ฺุฒ ุขูุงุฏู ุงุณุช! ๐**

ุจุฑุง ุดุฑูุน:
```bash
cd /home/charon-x/CharonX/chat-bots/anonymous-chat/backend
./scripts/run-migration.sh
npm run dev
```
